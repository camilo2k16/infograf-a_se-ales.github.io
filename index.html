import React, { useState } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Upload, AlertCircle } from 'lucide-react';

export default function MotorDataVisualizer() {
  const [data, setData] = useState(null);
  const [error, setError] = useState(null);

  const parseTextFile = (content) => {
    const lines = content.trim().split('\n');
    const parsedData = [];
    let currentEntry = {};

    for (let line of lines) {
      line = line.trim();
      if (line.startsWith('V:')) {
        currentEntry.V = parseFloat(line.split(':')[1].trim());
      } else if (line.startsWith('W:')) {
        currentEntry.W = parseFloat(line.split(':')[1].trim());
      } else if (line.startsWith('PWM:')) {
        currentEntry.PWM = parseFloat(line.split(':')[1].trim());
      } else if (line.startsWith('t:')) {
        currentEntry.t = parseFloat(line.split(':')[1].trim());
        parsedData.push({ ...currentEntry });
        currentEntry = {};
      }
    }

    // Eliminar los primeros 8 datos
    return parsedData.slice(8);
  };

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const content = e.target.result;
        const parsedData = parseTextFile(content);
        
        if (parsedData.length === 0) {
          setError('No se encontraron datos válidos en el archivo');
          setData(null);
          return;
        }

        // Agregar índice para las gráficas
        const dataWithIndex = parsedData.map((item, idx) => ({
          ...item,
          index: idx + 1
        }));

        setData(dataWithIndex);
        setError(null);
      } catch (err) {
        setError('Error al procesar el archivo: ' + err.message);
        setData(null);
      }
    };

    reader.onerror = () => {
      setError('Error al leer el archivo');
      setData(null);
    };

    reader.readAsText(file);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-7xl mx-auto">
        <h1 className="text-4xl font-bold text-gray-800 mb-8 text-center">
          Visualizador de Datos de Motores
        </h1>

        {/* Upload Section */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-8">
          <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors">
            <div className="flex flex-col items-center justify-center pt-5 pb-6">
              <Upload className="w-10 h-10 text-indigo-500 mb-2" />
              <p className="text-sm text-gray-600">
                <span className="font-semibold">Click para subir</span> o arrastra el archivo .txt
              </p>
            </div>
            <input
              type="file"
              className="hidden"
              accept=".txt"
              onChange={handleFileUpload}
            />
          </label>
        </div>

        {/* Error Message */}
        {error && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-8 flex items-start">
            <AlertCircle className="w-5 h-5 text-red-500 mr-2 mt-0.5" />
            <p className="text-red-700">{error}</p>
          </div>
        )}

        {/* Charts */}
        {data && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Gráfica 1: Velocidad de la Pieza */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">
                Velocidad de la Pieza (V)
              </h2>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={data}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis 
                    dataKey="index" 
                    label={{ value: 'Muestra', position: 'insideBottom', offset: -5 }}
                  />
                  <YAxis 
                    label={{ value: 'Velocidad (V)', angle: -90, position: 'insideLeft' }}
                  />
                  <Tooltip />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="V" 
                    stroke="#8b5cf6" 
                    strokeWidth={2}
                    dot={{ r: 3 }}
                    name="Velocidad"
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* Gráfica 2: Velocidad Angular de los Motores */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">
                Velocidad Angular de los Motores (W)
              </h2>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={data}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis 
                    dataKey="index" 
                    label={{ value: 'Muestra', position: 'insideBottom', offset: -5 }}
                  />
                  <YAxis 
                    label={{ value: 'Velocidad Angular (W)', angle: -90, position: 'insideLeft' }}
                  />
                  <Tooltip />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="W" 
                    stroke="#10b981" 
                    strokeWidth={2}
                    dot={{ r: 3 }}
                    name="Velocidad Angular"
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* Gráfica 3: PWM */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">
                PWM
              </h2>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={data}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis 
                    dataKey="index" 
                    label={{ value: 'Muestra', position: 'insideBottom', offset: -5 }}
                  />
                  <YAxis 
                    label={{ value: 'PWM', angle: -90, position: 'insideLeft' }}
                  />
                  <Tooltip />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="PWM" 
                    stroke="#f59e0b" 
                    strokeWidth={2}
                    dot={{ r: 3 }}
                    name="PWM"
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* Gráfica 4: Relación Tiempo vs PWM */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">
                Tiempo vs PWM
              </h2>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={data}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis 
                    dataKey="t" 
                    label={{ value: 'Tiempo (t)', position: 'insideBottom', offset: -5 }}
                  />
                  <YAxis 
                    label={{ value: 'PWM', angle: -90, position: 'insideLeft' }}
                  />
                  <Tooltip />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="PWM" 
                    stroke="#ef4444" 
                    strokeWidth={2}
                    dot={{ r: 3 }}
                    name="PWM"
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>
        )}

        {/* Info Message */}
        {!data && !error && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
            <p className="text-gray-600">
              Sube un archivo .txt para visualizar los datos. Los primeros 8 registros serán eliminados automáticamente.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
